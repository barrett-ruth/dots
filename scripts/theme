#!/bin/sh

themes="daylight
gruvbox
midnight"

as_list="$(printf "%s\n" "$themes" | awk 'NF{printf "\"%s\",", $0}' | sed 's/,$//')"

case "$(uname)" in
Linux)
  if [ -n "$1" ]; then
    theme="$1"
  else
    if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
      theme="$(printf "%s\n" "$themes" | rofi -dmenu -p 'theme')"
    else
      theme="$(printf "%s\n" "$themes" | dmenu -p 'theme: ')"
    fi
  fi
  ;;
Darwin)
  if [ -n "$1" ]; then
    theme="$1"
  else
    theme="$(
      osascript <<EOF
set theList to {$as_list}

set chosenTheme to (choose from list theList ¬
  with title "Theme" ¬
  with prompt "Pick a theme" ¬
  OK button name "Apply" ¬
  cancel button name "Cancel" ¬
  without empty selection allowed)

if chosenTheme is false then
  return ""
else
  return item 1 of chosenTheme
end if
EOF
    )"
  fi
  ;;
*)
  exit 1
  ;;
esac

[ -z "$theme" ] && exit 1

case "$(uname)" in
Linux)
  test -f "$XDG_CONFIG_HOME/sway/themes/theme" && ln -sf "$XDG_CONFIG_HOME/sway/themes/$theme" "$XDG_CONFIG_HOME/sway/themes/theme"

  test -d "$XDG_CONFIG_HOME/rofi/themes" && sed -i "s|@import \"themes/.*\.rasi\"|@import \"themes/$theme.rasi\"|" "$XDG_CONFIG_HOME/rofi/config.rasi"

  test -f "$XDG_CONFIG_HOME/sioyek/themes/theme.config" && ln -sf "$XDG_CONFIG_HOME/sioyek/themes/$theme.config" "$XDG_CONFIG_HOME/sioyek/themes/theme.config"

  test -f "$XDG_CONFIG_HOME/sioyek/themes/$theme.config" && ln -sf "$XDG_CONFIG_HOME/sioyek/themes/$theme.config" "$XDG_CONFIG_HOME/sioyek/themes/theme.config"

  test -f "$XDG_CONFIG_HOME/sioyek/prefs_user.config" && sed -i "s|^\(source ~/.config/sioyek/themes/\)[^/]*\.config$|\1$theme.config|" "$XDG_CONFIG_HOME/sioyek/prefs_user.config"

  if command -v gsettings >/dev/null 2>&1; then
    case "$theme" in
    gruvbox | midnight)
      gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
      ;;
    *)
      gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
      ;;
    esac
  fi

  [ "$XDG_SESSION_TYPE" = "wayland" ] && swaymsg reload
  ;;
esac


test -d "$XDG_CONFIG_HOME/fzf/themes" && ln -sf "$XDG_CONFIG_HOME/fzf/themes/$theme" "$XDG_CONFIG_HOME/fzf/themes/theme"

test -f ~/.zshenv && sed -i "s|^\(export THEME=\).*|\1$theme|" ~/.zshenv

if command -v tmux >/dev/null 2>&1; then
  test -f "$XDG_CONFIG_HOME/tmux/tmux.conf" && ln -sf "$XDG_CONFIG_HOME/tmux/themes/$theme.tmux" "$XDG_CONFIG_HOME/tmux/themes/theme.tmux"
  tmux source-file "$XDG_CONFIG_HOME/tmux/themes/$theme.tmux"
  tmux refresh-client -S
fi
