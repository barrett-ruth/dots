#!/bin/bash

usage() {
    cat <<EOF
Usage: hypr.sh <subcommand> <app> [args...]

Subcommands:
  spawnfocus       Focus an existing window of the app or spawn it if not running
  pull             Move the window of the app to the current workspace and focus it
  borders          Initialize dynamic borders, per github.com/devadathanmb/hyprland-smart-borders

Options:
  -h, --help       Show this help message
EOF
}

[ -z "$1" ] && { usage; exit 1; }
case "$1" in
  -h|--help) usage; exit 0 ;;
esac

SUBCMD="$1"
shift

[ -z "$1" ] && [ "$SUBCMD" != "borders" ] && { 
    echo "Error: invalid app specified"; 
    usage; 
    exit 1; 
}
APP="$1"
shift
ARGS="$*"

case "$APP" in
  google-chrome|google-chrome-stable) CLASS="google-chrome" ;;
  chromium|ungoogled-chromium) CLASS="Chromium" ;;
  firefox) CLASS="firefox" ;;
  alacritty) CLASS="Alacritty" ;;
  code|vscodium) CLASS="Code" ;;
  signal-desktop|signal) CLASS="signal" ;;
  telegram-desktop|telegram) CLASS="TelegramDesktop" ;;
  ghostty) CLASS="com.mitchellh.ghostty" ;;
  bitwarden-desktop|bitwarden) CLASS="Bitwarden" ;;
  slack) CLASS="Slack" ;;
  discord) CLASS="discord" ;;
  vesktop) CLASS="vesktop" ;;
  *) CLASS="$APP" ;;
esac

WIN_ADDR=$(hyprctl -j clients 2>/dev/null | jq -r --arg class "$CLASS" '
  .[]? | select(
    ((.xdgTag // "") | ascii_downcase | contains($class | ascii_downcase)) or
    ((.initialClass // "") | ascii_downcase | contains($class | ascii_downcase)) or
    ((.class // "") | ascii_downcase | contains($class | ascii_downcase))
  ) | .address
' | head -n 1)

case "$SUBCMD" in
  spawnfocus)
    if [ -n "$WIN_ADDR" ]; then
      hyprctl dispatch focuswindow "address:$WIN_ADDR"
    else
      "$APP" "$ARGS" &
    fi
    ;;
  pull)
    if [ -n "$WIN_ADDR" ]; then
      CURRENT_WS="$(hyprctl activeworkspace | head -n1 | awk -F'[()]' '{print $2}')"
      hyprctl dispatch movetoworkspace "$CURRENT_WS,address:$WIN_ADDR"
      hyprctl dispatch focuswindow "address:$WIN_ADDR"
    else
      echo "No running window of class '$CLASS' found to move"
      exit 1
    fi
    ;;
  borders)
    function handle {
      if [[ ${1:0:10} == "openwindow" ]]; then
        window_id=$(echo $1 | cut --delimiter ">" --fields=3 | cut --delimiter "," --fields=1)
        workspace_id=$(echo $1 | cut --delimiter ">" --fields=3 | cut --delimiter "," --fields=2)
        if [[ $workspace_id == "special" ]]; then
          workspace_id=-99
        fi
        windows=$(hyprctl workspaces -j | jq ".[] | select(.id == $workspace_id) | .windows")

        if [[ $windows -eq 1 ]]; then
          floating_status=$(hyprctl clients -j | jq ".[] | select(.address == \"0x$window_id\" ) | .floating")
          if [[ $floating_status == "false" ]]; then
            hyprctl dispatch setprop address:0x$window_id noborder 1
          else
            hyprctl dispatch setprop address:0x$window_id noborder 0
            return
          fi

        elif [[ $windows -eq 2 ]]; then
          addresses=$(hyprctl clients -j | jq -r --arg foo "$foo" ".[] | select(.workspace.id == $workspace_id) | .address")
          for address in $addresses; do
            if [[ "$address" != "$window_id" ]]; then
              hyprctl dispatch setprop address:$(echo $address | xargs) noborder 0
            fi
          done
        fi

      elif [[ ${1:0:10} == "movewindow" ]]; then
        window_id=$(echo $1 | cut --delimiter ">" --fields=3 | cut --delimiter "," --fields=1)
        workspace_id=$(echo $1 | cut --delimiter ">" --fields=3 | cut --delimiter "," --fields=2)

        if [[ $workspace_id == "special" ]]; then
          workspace_id=-99
        fi

        windows=$(hyprctl workspaces -j | jq ".[] | select(.id == $workspace_id) | .windows")

        if [[ $windows -eq 1 ]]; then
          floating_status=$(hyprctl clients -j | jq ".[] | select(.address == \"0x$window_id\" ) | .floating")
          if [[ $floating_status == "false" ]]; then
            hyprctl dispatch setprop address:0x$window_id noborder 1
          else
            hyprctl dispatch setprop address:0x$window_id noborder 0
            return
          fi
        elif [[ $windows -eq 2 ]]; then
          addresses=$(hyprctl clients -j | jq -r --arg foo "$foo" ".[] | select(.workspace.id == $workspace_id) | .address")
          for address in $addresses; do
            if [[ "$address" != "$window_id" ]]; then
              hyprctl dispatch setprop address:$(echo $address | xargs) noborder 0
            fi
          done
        fi

        single_window_workspaces=$(hyprctl workspaces -j | jq '.[] | select(.windows == 1)' | jq ".id")
        for workspace in $single_window_workspaces; do
          window=$(hyprctl clients -j | jq ".[] | select(.workspace.id == $workspace) | .address")
          hyprctl dispatch setprop address:$(echo $window | xargs) noborder 1
        done

      elif [[ ${1:0:11} == "closewindow" ]]; then
        workspace_id=$(hyprctl activewindow -j | jq ".workspace.id")
        windows=$(hyprctl workspaces -j | jq ".[] | select(.id == $workspace_id) | .windows")

        if [[ $windows -eq 1 ]]; then
          window_id=$(hyprctl activewindow -j | jq -r ".address")
          floating_status=$(hyprctl activewindow -j | jq ".floating")
          if [[ $floating_status == "false" ]]; then
            hyprctl dispatch setprop address:$window_id noborder 1
          else
            hyprctl dispatch setprop address:$window_id noborder 0
            return
          fi

        fi

      elif [[ ${1:0:18} == "changefloatingmode" ]]; then
        floating_status=$(echo $1 | cut --delimiter ">" --fields 3 | cut --delimiter "," --fields 2)
        address="0x$(echo $1 | cut --delimiter ">" --fields 3 | cut --delimiter "," --fields 1)"
        workspace_id=$(hyprctl clients -j | jq --arg address "$address" '.[] | select(.address == $address) | .workspace.id')
        if [[ $floating_status -eq 1 ]]; then
          hyprctl dispatch setprop address:$address noborder 0
        else
          no_windows=$(hyprctl workspaces -j | jq ".[] | select(.id == $workspace_id) | .windows")
          if [[ $no_windows -eq 1 ]]; then
            hyprctl dispatch setprop address:$address noborder 1
          else
            hyprctl dispatch setprop address:$address noborder 0
          fi
        fi
      fi
    }

    socat -U - UNIX-CONNECT:$(echo $XDG_RUNTIME_DIR)/hypr/$(echo $HYPRLAND_INSTANCE_SIGNATURE)/.socket2.sock | while read line; do handle $line; done
    ;;
  *)
    echo "Unknown subcommand: $SUBCMD"
    usage
    exit 1
    ;;
esac
